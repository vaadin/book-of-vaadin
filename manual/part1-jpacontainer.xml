<?xml version="1.0" encoding="UTF-8"?>

<chapter xml:id="jpacontainer">
    <title>Vaadin JPAContainer</title>

    <indexterm xml:id="term.jpacontainer" class="startofrange">
        <primary>JPAContainer</primary>
    </indexterm>

    <para>
        This chapter describes the use of the Vaadin JPAContainer add-on.
    </para>

    <para>
        <emphasis></emphasis>
    </para>

    <section xml:id="jpacontainer.overview">
        <title>Overview</title>

        <para>
            Vaadin JPAContainer add-on makes it possible to bind user interface components
            to a database easily using the Java Persistence API (JPA). It is an
            implementation of the <interfacename>Container</interfacename> interface
            described in <xref linkend="datamodel.container"/>.

            It supports a typical three-layer application
            architecture with an intermediate <emphasis>domain model</emphasis> between
            the user interface and the data access layer.
        </para>

		<figure xml:id="figure.jpacontainer.overview.architecture">
			<title>Three-Layer Architecture Using JPAContainer And JPA</title>
			<mediaobject>
				<imageobject role="html">
					<imagedata align="center" fileref="img/jpacontainer/three-layer-architecture-lo.png"/>
				</imageobject>
				<imageobject role="fo">
					<imagedata scale="75" smallscale="100%" align="center" fileref="img/jpacontainer/three-layer-architecture-hi.png"/>
				</imageobject>
			</mediaobject>
		</figure>

        <para>
            The role of Java Persistence API is to handle persisting the domain model in
            the database. The database is typically a relational database. Vaadin
            JPAContainer binds the user interface components to the domain model and
            handles database access with JPA transparently.
        </para>

        <para>
            JPA is really just an API definition and has many alternative
            implementations. Vaadin JPAContainer supports especially EclipseLink, which is
            the reference implementation of JPA, and Hibernate. Any other compliant
            implementation should work just as well. The architecture of an application
            using JPAContainer is shown in <xref
            lienkend="figure.jpacontainer.overview.detailed-architecture"/>.
        </para>

		<figure xml:id="figure.jpacontainer.overview.detailed-architecture">
			<title>JPAContainer Architecture</title>
			<mediaobject>
				<imageobject role="html">
					<imagedata align="center" fileref="img/jpacontainer/detailed-architecture-lo.png"/>
				</imageobject>
				<imageobject role="fo">
					<imagedata scale="75" smallscale="100%" align="center" fileref="img/jpacontainer/detailed-architecture-hi.png"/>
				</imageobject>
			</mediaobject>
		</figure>

        <para>
            Vaadin JPAContainer also plays together with the Vaadin Bean Validation
            add-on, which brings Java Bean Validation (JSR 303) to Vaadin applications.
        </para>

        <simplesect xml:id="jpacontainer.overview.jpa">
            <title>Java Persistence API</title>

            <para>
                Java Persistence API (JPA) is an API for object-relational mapping (ORM)
                of Java objects to a relational database. In JPA and entity-relationship
                modeling in general, a Java class is considered an
                <emphasis>entity</emphasis>. Class (or entity) instances correspond with a
                row in a database table and member variables of a class with
                columns. Entities can also have relationships with other entities.
            </para>

            <para>
                Vaadin JPAContainer supports JPA 2.0 (JSR 317). 
            </para>
        </simplesect>

        <simplesect xml:id="jpacontainer.overview.metadata">
            <title>Persistence Metadata</title>

            <para>
                JPA requires metadata about the entities and their relationships. The
                metadata can be defined in an XML metadata file or with Java annotations
                defined in the javax.persistence package. With JPAContainer, you need to
                provide the metadata as annotations.
            </para>

            <para>
                For example, if we look at the Person class in the JPAContainer
                AddressBook Demo, we define various database-related metadata for the
                member variables of a class:
            </para>

			<programlisting><?pocket-size 75% ?><![CDATA[@Entity
public class Person {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @NotNull
    @Size(min = 2, max = 24)
    private String firstName;

    @Size(min = 2, max = 24)
    private String lastName;

    @NotNull
    private Department department;
    $B!D(B]]></programlisting>

            <para>
                The JPA implementation uses reflection to read the annotations and defines
                a database model automatically from the class definitions. <!-- TODO JPA
                annotation is discussed in detail later in Section 4.3: Annotating the
                Classes for Persistence. -->
            </para>
        </simplesect>

        <simplesect xml:id="jpacontainer.overview.documentation">
            <title>Documentation and Support</title>

            <para>
                The installation package includes the following documentation about
                JPAContainer:
            </para>

            <itemizedlist>
                <listitem>
                    <para>
                        API Documentation
                    </para>
                </listitem>
                <listitem>
                    <para>
                        AddressBook Demo
                    </para>
                </listitem>
                <listitem>
                    <para>
                        JPAContainer Tutorial
                    </para>
                </listitem>
            </itemizedlist>
        </simplesect>
    </section>

    <section xml:id="jpacontainer.installation">
        <title>Installing</title>

        <section xml:id="jpacontainer.installation.download">
            <title>Downloading the Package</title>

            <simplesect xml:id="jpacontainer.installation.download.license">
                <title>Choosing the License</title>

                <para>
                    Vaadin JPAContainer is available under two licenses: Affero General
                    Public License (AGPL) and Commercial Vaadin Add-on License (CVAL). If
                    your project is compatible with the open-source AGPL, you can use the
                    add-on for free. Otherwise you must acquire a sufficient number of
                    CVAL licenses before the 30-day trial period ends. Vaadin JPAContainer
                    is distributed as a separate installation package for each license.
                </para>

                <para>
                    Use of Vaadin JPAContainer with the CVAL license is included in the
                    Vaadin PRO subscription.
                </para>
            </simplesect>
        </section>

        <section xml:id="jpacontainer.installation.package">
            <title>Installation Package Content</title>

            <para>
                Once extracted to a local folder, the contents of the installation
                directory are illustrated in Figure 4.
            </para>

Figure 4: Installation Package Contents

            <para>
                The files in the installation package are as follows:
            </para>

            <variablelist>
                <varlistentry>
                    <term><filename>README</filename></term>
                    <listitem>
                        <para>
                            A readme file describing the package contents.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>licensing.txt</filename></term>
                    <listitem>
                        <para>
                            General information about licensing of JPAContainer.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>license-xxxx-y.y.txt</filename></term>
                    <listitem>
                        <para>
                            The full license text for the library.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>vaadin-jpacontainer-xxxx-y.y-z.z.z.jar</filename></term>
                    <listitem>
                        <para>
                            The actual Vaadin JPAContainer library. The xxxx is the
                            license name and y.y its version number. The final z.z.z is
                            the version number of the Vaadin JPAContainer.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>vaadin-jpacontainer-xxxx-y.y-z.z.z-javadoc.jar</filename></term>
                    <listitem>
                        <para>
                            JavaDoc documentation JAR for the library. You can use it for
                            example in Eclipse by associating the JavaDoc JAR with the
                            JPAContainer JAR in the build path settings of your project.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>apidocs</filename></term>
                    <listitem>
                        <para>
                            A folder containing the JavaDoc API documentation in plain
                            HTML.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>jpacontainer-tutorial.pdf</filename></term>
                    <listitem>
                        <para>
                            The tutorial in PDF format.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>jpacontainer-tutorial</filename></term>
                    <listitem>
                        <para>
                            The tutorial in HTML format. The latest version of the
                            tutorial is always available at
                            vaadin.com/download/jpacontainer-tutorial/.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>jpacontainer-addressbook-demo</filename></term>
                    <listitem>
                        <para>
                            The JPAContainer AddressBook Demo project covered in this
                            tutorial. You can compile and package the application as a WAR
                            with <screen><command>mvn</command>
                            <parameter>package</parameter></screen>¡ or launch it in the
                            Jetty web browser with <screen><command>mvn</command>
                            <parameter>jetty:run</parameter></screen>.  You can also
                            import the demo project in Eclipse as described in Section
                            3.1.2: Importing from Existing Installation Folder.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>jpacontainer-demo-z.z.z.war</filename></term>
                    <listitem>
                        <para>
                            The basic JPAContainer demo. It is somewhat more extensive
                            than the AddressBook Demo.
                        </para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
    </section>

    <section xml:id="jpacontainer.usage">
        <title>Basic Use</title>
    </section>

    <section xml:id="jpacontainer.fieldfactory">
        <title>Automatic Form Generation</title>

        <para>
            The JPAContainer <classname>FieldFactory</classname> is an implementation of
            the <interfacename>FormFieldFactory</interfacename> and
            <interfacename>TableFieldFactory</interfacename> interfaces that can generate
            fields based on the JPA annotations in a POJO. It goes further than the
            <classname>DefaultFieldFactory</classname>, which only creates simple fields
            for the basic data types. This way you can create CRUD views easily, in a
            fashion similar to what the Vaadin Plugin for Spring Roo allows.
        </para>

        <para>
            The generated defaults are as follows:
        </para>

        <informaltable>
            <tgroup cols="2">
                <thead>
                    <row>
                        <entry><para>Annotation</para></entry>
                        <entry><para>Class Mapping</para></entry>
                    </row>
                </thead>
                <tbody>
                    <row>
                        <entry><para><literal>@ManyToOne</literal></para></entry>
                        <entry><para><classname>NativeSelect</classname></para></entry>
                    </row>
                    <row>
                        <entry><para><literal>@OneToOne</literal></para></entry>
                        <entry><para>Nested <classname>Form</classname></para></entry>
                    </row>
                    <row>
                        <entry><para><literal>@OneToMany</literal></para></entry>
                        <entry><para><classname>MasterDetailEditor</classname> (see below)</para></entry>
                    </row>
                    <row>
                        <entry><para><literal>@ManyToMany</literal></para></entry>
                        <entry><para>Selectable <classname>Table</classname></para></entry>
                    </row>
                </tbody>
            </tgroup>
        </informaltable>

        <!-- TODO: Stuff added in [22470] -->

        <para>
            The field factory is recusive, so that you can edit a complex object tree with
            one form.
        </para>

        <section xml:id="jpacontainer.fieldfactory.masterdetaileditor">
            <title>Master-Detail Editor</title>

            <para>
                The <classname>MasterDetailEditor</classname> is a complete implementation
                of the Master-Detail pattern where you can add and remove items or select
                an item to edit it.

                <!-- Removal of entities (actually relationships between entities depending on the cascade rule) -->
            </para>
        </section>

        <section xml:id="jpacontainer.fieldfactory.configuring">
            <title>Configuring the Field Factory</title>

            <para>
                The <classname>FieldFactory</classname> is highly configurable with
                various configuration settings and by extending. You need to make the
                configuration before 
            </para>

            <para>
                The <methodname>setMultiSelectType()</methodname> and
                <methodname>setSingleSelectType()</methodname> allow you to specify a
                selection component that is used instead of the default for a field with
                <literal>@ManyToMany</literal> and <literal>@ManyToOne</literal>
                annotation, respectively. The first parameter is the class type of the
                field, and the second parameter is the class type of a selection
                component. It must be a sub-class of
                <classname>AbstractSelect</classname>.
            </para>

            <para>
                The <methodname>setVisibleProperties()</methodname> controls which
                properties (fields) are visible in generated forms, subforms, and
                tables. The first paramater is the class type for which the setting should
                be made, followed by the IDs of the visible properties.
            </para>

            <para>
                Further configuration must be done by extending the many protected
                methods. Please see the API documentation for the complete list.
            </para>
        </section>

        <section xml:id="jpacontainer.fieldfactory.using">
            <title>Using the Field Factory</title>

            <para>
                The basic use of the <classname>FieldFactory</classname> goes as follows:
            </para>

			<programlisting><?pocket-size 75% ?><![CDATA[// Create a form
customerForm = new Form();
customerForm.setCaption("EditCustomer groups");

// Create a field factory for the form
FieldFactory jpaContainerFieldFactory = new FieldFactory();

// Optional configuration:
jpaContainerFieldFactory.setVisibleProperties(InvoiceRow.class,
        "product", "description", "unit", "unitPrice");
jpaContainerFieldFactory.setVisibleProperties(BillingAddress.class, "street", "city", "postalCode");
jpaContainerFieldFactory.setSingleSelectType(Customer.class, ListSelect.class);

customerForm.setFormFieldFactory(jpaContainerFieldFactory);
addComponent(customerForm);]]></programlisting>
        </section>

        <para>
            Notice that the configuration should be done before actually binding the form.
        </para>

        <para>
            If you use Hibernate, you also need to pass an
            <classname>EntityManagerPerRequestHelper</classname>, either for the
            constructor or with
            <methodname>setEntityManagerPerRequestHelper()</methodname>.
        </para>
    </section>

    <indexterm startref="term.jpacontainer" class="endofrange"/>
</chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: xml
sgml-omittag:nil
sgml-shorttag:nil
sgml-namecase-general:nil
sgml-general-insert-case:lower
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:4
sgml-indent-data:t
sgml-parent-document:nil
sgml-exposed-tags:nil
sgml-local-catalogs:("/etc/sgml/catalog" "/usr/share/xemacs21/xemacs-packages/etc/psgml-dtds/CATALOG")
sgml-local-ecat-files:("ECAT" "~/sgml/ECAT" "/usr/share/sgml/ECAT" "/usr/local/share/sgml/ECAT" "/usr/local/lib/sgml/ECAT")
End:
-->
